@Service
public class AccountComplianceReconService {

    /**
     * Builds a list of AccountComplianceRecon objects by comparing input details with the DB entity map.
     * For fields that exist in both input and output, it directly maps them. For acct_compliance_code,
     * if the value is "FAP", then fw_flagStatus_string is forced to "FC". For a few fields, if the input
     * value is missing, it falls back to the DB entity value.
     *
     * @param dbEntityMap  Map of primary key (fw_id) to CreditCardAccountComplianceEntity
     * @param inputDetails List of AccountComplianceDetails coming from the input
     * @return List of fully populated AccountComplianceRecon objects
     */
    public List<AccountComplianceRecon> compareAndBuildRecon(
            Map<String, CreditCardAccountComplianceEntity> dbEntityMap,
            List<AccountComplianceDetails> inputDetails
    ) {
        List<AccountComplianceRecon> reconList = new ArrayList<>();

        for (AccountComplianceDetails input : inputDetails) {
            // Lookup DB entity using the primary key (fw_id)
            CreditCardAccountComplianceEntity dbEntity = dbEntityMap.get(input.getFw_id());
            
            AccountComplianceRecon recon = new AccountComplianceRecon();

            // Map primary key
            recon.setFw_id(input.getFw_id());

            // Map acct_compliance_code (input takes precedence; fallback to DB if needed)
            if (isNotEmpty(input.getAcct_compliance_code())) {
                recon.setAcct_compliance_code(input.getAcct_compliance_code());
            } else if (dbEntity != null && isNotEmpty(dbEntity.getComplianceCode())) {
                recon.setAcct_compliance_code(dbEntity.getComplianceCode());
            } else {
                recon.setAcct_compliance_code(null);
            }

            // Map acct_compliance_effectiveDate (input takes precedence; fallback to DB)
            if (isNotEmpty(input.getAcct_compliance_effectiveDate())) {
                recon.setAcct_compliance_effectiveDate(input.getAcct_compliance_effectiveDate());
            } else if (dbEntity != null && isNotEmpty(dbEntity.getComplianceEffectiveDate())) {
                recon.setAcct_compliance_effectiveDate(dbEntity.getComplianceEffectiveDate());
            } else {
                recon.setAcct_compliance_effectiveDate(null);
            }

            // Map cust_reltnshp_cd_string directly from input
            recon.setCust_reltnshp_cd_string(input.getCust_reltnshp_cd_string());

            // Map acct_tax_status_cd_string directly from input
            recon.setAcct_tax_status_cd_string(input.getAcct_tax_status_cd_string());

            // CASE LOGIC for fw_flagStatus_string:
            // If acct_compliance_code equals "FAP" then force fw_flagStatus_string to "FC",
            // otherwise, simply pass the input value.
            if ("FAP".equals(input.getAcct_compliance_code())) {
                recon.setFw_flagStatus_string("FC");
            } else {
                recon.setFw_flagStatus_string(input.getFw_flagStatus_string());
            }

            // Map acct_first_mia_indicator directly from input
            recon.setAcct_first_mia_indicator(input.getAcct_first_mia_indicator());

            // Map acct_fee_status_code directly from input
            recon.setAcct_fee_status_code(input.getAcct_fee_status_code());

            // Map FW_HdrTimestamp directly from input
            recon.setFW_HdrTimestamp(input.getFW_HdrTimestamp());

            // Map load_ts directly from input
            recon.setLoad_ts(input.getLoad_ts());

            reconList.add(recon);
        }

        return reconList;
    }

    /**
     * Utility method to check if a String is non-null and not just whitespace.
     */
    private boolean isNotEmpty(String value) {
        return value != null && !value.trim().isEmpty();
    }
}